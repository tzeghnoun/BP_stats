---
title: "DASHBOARD" 
date: "`r Sys.Date()`"
output: 
  flexdashboard::flex_dashboard:
    # social: ["menu"]
    source_code: embed
    vertical_layout: fill
    theme: united
---

This dashboard displays energy data from  [BP Statistical Review of the World 2019](https://www.bp.com/en/global/corporate/energy-economics/statistical-review-of-world-energy.html).

``` {js}
$('.navbar-inverse').removeClass('navbar-inverse').addClass('navbar-default');
```

```{r setup, include=FALSE}

library(flexdashboard) # Dashboard package
source("bp_stats_load_clean.R") 
```

<style>                     
.navbar {
  background-color:#003D79;
  border-color:white;

}

.custom {
    background-color: aliceblue;
    border-color: #ffffff;
}

</style>


Primary Energy {data-icon="fa-signal"}
=======================================================================

 Column {.tabset .tabset-fade data-width=550 .custom }
-----------------------------------------------------------------------

### __World enegy consumption__ {.no-padding data-icon="fa-signal"}
```{r fig.height=3, message=FALSE, warning=FALSE}
# create DT for Primary Energy Consumption (Million tonnes oil equivalent)
energy_cons <- wide_to_long_1(2) 
setDT(energy_cons)
energy_cons <- energy_cons[, .(primary_energy_consumption = round(as.numeric(.SD), 2)), by = .(country,year), .SDcols=3]
# Add regions & clean unused rows (totals & remarks)  
energy_cons <- get_regions(energy_cons)

# Create a line plot.
highchart() %>% 
    hc_add_series(energy_cons[, list(total_rg = sum(primary_energy_consumption, na.rm = T)), by = c("region", "year")], hcaes(x = year, y = total_rg, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Consumption: <b>{point.y}</b>")) %>%
    hc_title(text = "Total primary energy consumption by region") %>% 
    hc_subtitle(text = "Mtoe") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Primary Energy: Consumption - Mtoe (from 1965)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())

```


### __Consumption by fuel__  {.no-padding}
```{r fig.height=3}
# create DT for Primary Energy Consumption by fuel (Million tonnes oil equivalent)
fuel <- as.data.table(bp_stats$list.element[[3]]) %>% 
                        setNames(c("country", "oil_17", "ngas_17", "coal_17", "nuclear_17", "hydroelectric_17", 
                                   "renewables_17", "total_17", "oil_18", "ngas_18", "coal_18", "nuclear_18", "hydroelectric_18", 
                                   "renewables_18", "total_18")) %>%
  .[, idx := if_else(str_detect(country, "^Total"), .I, 0L)] %>% #create an index that detect row numbers where the country column is a name of the region (i.e Total Africa)  
  na.omit(., cols="country") %>%
   add_row() # add a row to help getting rid of the last rows that represent comments  
# Add regions & clean unused rows (totals & remarks)  
fuel <- get_regions(fuel)
# create an aggregated DT by fuel by region
fuel_region <- fuel[, lapply(.SD, sum, na.rm=TRUE), .SDcols=2:15, by = region]
# create a DT of total consumption of fuel for 2017 & 2018 for plotting
fuel_plot_data <- melt(fuel_region, id.vars = c("region"), measure.vars = c("oil_17", "ngas_17", "coal_17", "nuclear_17", "hydroelectric_17", "renewables_17", "total_17", "oil_18", "ngas_18", "coal_18", "nuclear_18", "hydroelectric_18", "renewables_18", "total_18")) %>% # MElting our DT (from large to wide table)
 .[, c("fuel", "tmp") := tstrsplit(variable, "_", fixed=TRUE) # Separate the column in two variables
   ] %>% 
  .[, .(year = if_else(str_detect(tmp, "17"), 2017, 2018),
        fuel_cons=round(sum(value, na.rm = T))), by = .(region, fuel, tmp)] 

# Create line plot.
hchart(fuel_plot_data[year == "2018", .(region, fuel_cons, freq =paste0(round((100*fuel_cons)/sum(fuel_cons, na.rm = TRUE), 2), "%")), by = .(fuel)], "column", hcaes(x = fuel, y = fuel_cons, group = region)) %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("region: <b>{point.region}</b><br>", "Consumption: <b>{point.y}</b><br>", "Contribution: <b>{point.freq}</b>")) %>%
    hc_title(text = "Total primary energy consumption by fuel (2018)") %>%
    hc_subtitle(text = "Million tonnes oil equivalent") %>%
    hc_xAxis(title = list(text = "fuel")) %>%
  hc_yAxis(title = list(text = "Primary Energy Consumption by fuel in 2018")) %>%
  hc_add_theme(hc_theme_economist())

```


### __Contribution to primary energy growth__ {.no-padding}
```{r fig.height=3}
# Summarize the contribution to primary energy growth for 2018.  
contribution_18 <- energy_cons[year %in% c(2017, 2018) & country != "USSR"
                               ][order(-primary_energy_consumption)
                                 ][, country_rank := ifelse(.I <=8, country, region)
                                   ][, .(total_cons = sum(primary_energy_consumption, na.rm = T)), by = c("country_rank", "year", "region")]
# Extract the regions of top 4 contributeurs to convert them to Other regions for the other countries belonging to those regions (here : Other America, Other Asia & Other CIS)
region_rank <- contribution_18[1:8,  .(region = unique(region))]
contribution_18 <- contribution_18[, country_rank := ifelse(country_rank %in% region_rank$region, paste0("other_", country_rank), country_rank)][order(-year, -total_cons)][!is.na(region)][order(year, - total_cons)]
# Calculate top 3 contributors in 2018
# Adding the difference Y-on-Y by for each country & for the total (lag) in order to calculate the percentage of contribution to the growth by country / region
Annual_gr <- na.omit(contribution_18[order(year)
                                     ][, lapply(.SD, function(x) 
                                       x-shift(x)), by = country_rank, .SDcols=4
                                       ][, c("country", "diff_17_18", "contribution_18", "total_cons", "country_rank") := .(country_rank, total_cons, round(100*total_cons / sum(total_cons, na.rm = T), 2), NULL, NULL)
                                         ])[order(-contribution_18)]
                               
top_3_contr <- Annual_gr[, head(.SD, 3), .SDcols=c("country", "contribution_18")][, .(contrib = sum(contribution_18))] %>% 
  pull()

# Create a line plot.
highchart() %>%
    hc_add_series(Annual_gr, hcaes(x = country, y = contribution_18, group = country), type = "column") %>%
    hc_tooltip(pointFormat = paste("<b>{point.y} %</b>")) %>%
    hc_title(text = "Contribution to primary energy growth in 2018 (%)") %>%
    hc_subtitle(text = "Mtoe") %>%
    hc_yAxis(title = list(text = "Contribution to primary energy growth (%)"),
             labels = list(format = "{value}%")) %>%
  hc_add_theme(hc_theme_538())

```


Column {data-width=300}
-----------------------------------------------------------------------

```{r include=FALSE}
# Calculating 2018 growth compared to 2017 (= (cons_18 - cons_17) / cons_2017)
growth_17_18  <- round(100*(energy_cons[, list(total_rg = sum(primary_energy_consumption, na.rm = T)), by = c("region", "year")][year == 2018, list(cons_2018 = sum(total_rg, na.rm = T))] - energy_cons[, list(total_rg = sum(primary_energy_consumption, na.rm = T)), by = c("region", "year")][year == 2017, list(cons_2017 = sum(total_rg, na.rm = T))]) / energy_cons[, list(total_rg = sum(primary_energy_consumption, na.rm = T)), by = c("region", "year")][year == 2017, list(cons_2017 = sum(total_rg, na.rm = T))], 1)

# Functions for the boxvalues
Growth_Global_Primary_Energy = function(...) return(growth_17_18)
NaturalGas = function(...) return("40") # Should calculate it & put the variable instead
Contribution = function(...) return(top_3_contr)

```

### Growth of global primary energy consumption (%).

```{r}
articles = Growth_Global_Primary_Energy()
valueBox(articles, icon = "fa-percent", color = "orange")
```

### Energy consumption growth driven by natural gas (40%).

```{r}
comments = NaturalGas()
valueBox(comments, icon = "fa-percent", color = "orange")
```

### China, US & India accounted for more than two thirds of the global increase in energy demand (%).

```{r}
cont = Contribution()
valueBox(cont, icon = "fa-percent", color = "orange")
```


Oil {data-icon="fa-signal"} 
========================================================================

Column {.tabset .tabset-fade data-width=550 .custom }
-----------------------------------------------------------------------

### __Map of Oil Reserves by country in 2018__ {.custom }
```{r fig.height=3}
# Import region map data. 
data(worldgeojson, package = "highcharter")

# Create DT of Oil: Proved reserves (thousand million barrels)
oil_reserves <- wide_to_long_1(6) %>% 
  .[, oil_proved_reserves_history := round(as.numeric(oil_proved_reserves_history), 2)]
# Add regions & clean unused rows (totals & remarks)  
oil_reserves <- get_regions(oil_reserves)

# Change the names of "Russian Federation" to "Russia" & "US", "United States of America" for plotting
oil_reserves <- oil_reserves[, c("country", "oil_proved_reserves") := .(ifelse(country == "US", "United States of America", ifelse(country == "Russian Federation", "Russia", country)), oil_proved_reserves = oil_proved_reserves_history)]

# Create region map with energy data. 
highchart() %>%
hc_add_series_map(worldgeojson, oil_reserves[year == 2018], value = "oil_proved_reserves", joinBy = c('name','country'), name = "Oil Reserves (Thousand million barrels)")  %>% 
    hc_colorAxis(stops = color_stops()) %>%
    hc_title(text = "Oil Reserves by country in 2018") %>% 
    hc_subtitle(text = "Thousand million barrels") %>%
    hc_tooltip(borderWidth = 1.5, valueSuffix = '') %>%
    hc_add_theme(hc_theme_economist()) 

```

### __Global oil production__ {.custom }
```{r fig.height=3}
# Create DT of oil_production (Thousand barrels daily)
oil_production <- wide_to_long_1(7) %>% 
  .[, oil_production_barrels := round(as.numeric(oil_production_barrels), 2)]
# Add regions & clean unused rows (totals & remarks)  
oil_production <- get_regions(oil_production)

oil_production <- oil_production[, country := ifelse(country == "US", "United States of America", ifelse(country == "Russian Federation", "Russia", country))]

# Create the plot with energy data. 
highchart() %>% 
    hc_add_series(oil_production[, .(total_oil_production = sum(oil_production_barrels, na.rm =T)), by=.(year, region)], hcaes(x = year, y = total_oil_production/10^3, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Production: <b>{point.y}</b>")) %>%
    hc_title(text = "Total oil production by region") %>% 
    hc_subtitle(text = "Millions barrels daily") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Oil Production - MMbbl (from 1965)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())

```

### __Oil proved, production & consumption__ {.no-padding .custom }
```{r fig.height=3}
# Create tibble for oil_consumption.
oil_consumption <- wide_to_long_1(11) %>% 
  .[, list(country = country,
           year = year,
           oil_consumption_barrels = round(as.numeric(oil_consumption_barrels), 2))]
# Add regions & clean unused rows (totals & remarks)  
oil_consumption <- get_regions(oil_consumption)
oil_consumption <- oil_consumption[, country := ifelse(country == "US", "United States of America", ifelse(country == "Russian Federation", "Russia", country))]

# create plot_data by joining the 3 df   
merged_oil <- merge(oil_reserves, oil_production, by = c("country", "year", "region"))

merged_oil <- merge(merged_oil, oil_consumption, by = c("country", "year", "region")) 
# Set porduction & consumption to millions as  they are in thousands unlike reserves that are already millions 

merged_oil <- merged_oil[, .(region = region,
               country = country,
               year = year,
               oil_proved_reserves = round(oil_proved_reserves, 2),
               oil_production = round(oil_production_barrels/10^3, 2),
               oil_consumption = round(oil_consumption_barrels/10^3, 2))]

merged_oil <- merged_oil[, region := ifelse(country == "Algeria", country, region)]

base <- merged_oil %>%
  plot_ly(x = ~oil_consumption, y = ~oil_production, 
          text = ~country, hoverinfo = "text", color = ~ region) %>%
  layout(xaxis = list(type = "sqrt")) %>%
  layout(yaxis = list(type = "log"))

base %>%
  add_markers(frame = ~year, ids = ~country, sizeref = 4000, size = ~oil_proved_reserves^10, sizes = c(100, 500), alpha = 0.8, alpha_stroke = 0.8) %>%
  animation_opts(1000, easing = "elastic", redraw = FALSE) %>%
  animation_button(
    x = 1, xanchor = "right", y = 0, yanchor = "bottom"
  ) %>%
  animation_slider(
    currentvalue = list(prefix = "YEAR ", font = list(color="red"))
  )
  
```

### __Refinery throughput__ {.no-padding .custom }
```{r fig.height=3}
# Create DT of Refinery throughput (Thousand barrels daily).
refinery_throughput <- wide_to_long_1(17) %>% 
  .[, oil_refinery_throughput := round(as.numeric(oil_refinery_throughput), 2)]
# Add regions & clean unused rows (totals & remarks)  
refinery_throughput <- get_regions(refinery_throughput)

# Create DT of Refinery capacity (Thousand barrels daily).
refinery_capacity <- wide_to_long_1(18) %>% 
  .[, oil_refining_capacity := round(as.numeric(oil_refining_capacity), 2)]
# Add regions & clean unused rows (totals & remarks)  
refinery_capacity <- get_regions(refinery_capacity)

# Merging refinery throughput & capacity
refinery_merged_rg <- merge(refinery_capacity[, .(refinery_capacity_rg = sum(oil_refining_capacity, na.rm = T)), by = .(region, year)], refinery_throughput[, .(refinery_throughput_rg = sum(oil_refinery_throughput, na.rm = T)), by = .(region, year)], by = c("region", "year"))

refinery_merged_rg <- refinery_merged_rg[, utilization := round(100*refinery_throughput_rg/refinery_capacity_rg), by = .(region, year)]

# create plot_data    
highchart() %>% 
    hc_add_series(refinery_merged_rg[year > 2007], hcaes(x = year, y = utilization, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Refinery Utilization: <b>{point.y}</b>")) %>%
    hc_title(text = "Refinery utilization by region") %>% 
    hc_subtitle(text = "Percentage (based on average annual capacity)") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Utilization rate (%)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())

```



### __Regional refining margins__ {.no-padding .custom }
```{r fig.height=3}
# Create DT of Refinery mergins (US dollars per barrel).
refinery_margins <- as.data.table(bp_stats$list.element[[19]] %>% 
  setNames(c("Date", "USGC_Medium_Sour_Coking", "NWE_Light_Sweet_Cracking", "Singapore_Medium_Sour_Hydrocracking")) %>% 
  filter(!is.na(Date), !is.na(USGC_Medium_Sour_Coking)))

refinery_margins <- refinery_margins[, lapply(.SD, as.numeric), by = Date, .SDcols=2:4][, lapply(.SD, round), by = Date, .SDcols=2:4]
# Need to transforme the first column to date structure
refinery_margins <- refinery_margins[, Date := str_replace(Date, "Q", "/")][, Date := as.yearqtr(Date, format = "%q/%y")]
# MElting our DT (from large to wide table)
refinery_margins <- melt(refinery_margins, id.vars = c("Date"),
                measure.vars = c("USGC_Medium_Sour_Coking", "NWE_Light_Sweet_Cracking", "Singapore_Medium_Sour_Hydrocracking"))
# create plot_data 
highchart() %>%
    hc_add_series(refinery_margins, hcaes(x = Date, y = value, group = variable, color = variable), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Date: <b>{point.x}</b> <br>","Regional margins: <b>{point.variable}</b><br>", "Value: <b>{point.y}</b>")) %>%
    hc_title(text = "Regional refining margins") %>%
    hc_subtitle(text = "US dollars per barrel") %>%
    hc_xAxis(format = "%q/%y") %>%
    hc_yAxis(title = list(text = "Oil: Regional refining margins")) %>%
    hc_legend(enabled = F) %>%
    hc_add_theme(hc_theme_economist())


```

### __Spot crude prices ($/bbl)__ {.no-padding}
```{r fig.height=3}
# Create DT for Spot oil prices
oil_spots <- as.data.table(bp_stats$list.element[[15]] %>% 
  setNames(c("year", "Dubai", "Brent", "Forcados", "WTI")) %>% 
  filter(!is.na(year)))
oil_spots <- oil_spots[!(str_detect(year, "[a-zA-Z]+")), .(year = as.integer(year),
                                                           Dubai = round(as.numeric(Dubai), 2),
                                                           Brent = round(as.numeric(Brent), 2),
                                                           Forcados = round(as.numeric(Forcados), 2),
                                                           WTI = round(as.numeric(WTI), 2))]
  

oil_spots %>% 
  dygraph(main = "Spot crude prices ($/bbl)") %>% 
  dyRangeSelector() %>% 
  dyOptions(drawPoints = TRUE, pointSize = 2) %>%
  dyShading(from = "1978", to = "1986", color = "#FFE6E6") %>%
  dyShading(from = "2000", to = "2008", color = "#CCEBD6") %>%
  dyShading(from = "2011", to = "2016", color = "#FFE6E6") %>% 
  dyEvent("1986", "The 1986 oil price collapse", labelLoc = "bottom") %>% 
  dyEvent("2008", "Subprime mortgage crisis", labelLoc = "bottom") %>% 
  dyEvent("2014", "Oil price crash", labelLoc = "bottom")
```


Column {data-width=300}
-----------------------------------------------------------------------


```{r include=FALSE}
# these computing functions for the boxvalues
Oil_Price = function(...) return("$71.31 per barrel")
Oil_Consumption = function(...) return("1.4 million b/d")
Oil_Production = function(...) return("2.2 million b/d")
Refinery_Throughput = function(...) return("960,000 b/d")

```

### Annual average Dated Brent 2018.

```{r}
articles = Oil_Price()
valueBox(articles, icon = "fa-dollar", color = "orange") 
```

### Oil consumption grew by an above-average of 1.5% (China (680 kb/d) & US (500 kb/d) the largest contributors).

```{r}
comments = Oil_Consumption()
valueBox(comments, icon = "fa-area-chart", color = "orange")
```

### Global oil production (mainly from US).

```{r}
cont = Oil_Production()
valueBox(cont, icon = "fa-area-chart", color = "orange")
```

### Refinery throughput (down from 1.5 million b/d in 2017).

```{r}
refinery = Refinery_Throughput()
valueBox(refinery, icon = "fa-area-chart", color = "orange") 
```


Gas {data-icon="fa-signal"}
========================================================================

Column {.tabset .tabset-fade data-width=550 .custom }
-----------------------------------------------------------------------

### __Map of Gas Reserves by country in 2018__ {.custom }
```{r fig.height=3}
# Create DT for Gas Proved reserves (Trillion cubic metres)
gas_reserves <- wide_to_long_1(24) %>% 
  .[, gas_proved_reserves := round(as.numeric(gas_proved_reserves_history_), 2)]
# Add regions & clean unused rows (totals & remarks)  
gas_reserves <- get_regions(gas_reserves)

# Change the names of "Russian Federation" to "Russia" & "US", "United States of America" for plotting
gas_reserves <- gas_reserves[, country := ifelse(country == "US", "United States of America", ifelse(country == "Russian Federation", "Russia", country))]

# Create region map with energy data. 
highchart() %>%
hc_add_series_map(worldgeojson, gas_reserves[year == 2018], value = "gas_proved_reserves", joinBy = c('name','country'), name = "Gas Reserves (Trillion cubic metres)")  %>% 
    hc_colorAxis(stops = color_stops()) %>% 
    hc_title(text = "Gas Reserves by country in 2018") %>% 
    hc_subtitle(text = "Trillion cubic metres") %>%
    hc_tooltip(borderWidth = 1.5, valueSuffix = '') %>%
    hc_add_theme(hc_theme_economist()) 

```

### __Natural gas consumption__ {.no-padding}
```{r fig.height=3}
# Create DT for Natural Gas Consumption (Billion cubic metres)
ng_cons <- wide_to_long_1(28) %>% 
  .[, gas_consumption_bcm := round(as.numeric(gas_consumption_bcm), 2)]
# Add regions & clean unused rows (totals & remarks)  
ng_cons <- get_regions(ng_cons)

ng_cons_diff_17_18 <- ng_cons[year %in% c(2017, 2018), .(total_gas_consumption = sum(gas_consumption_bcm, na.rm = T)), by = .(year)][, total_gas_consumption - shift(total_gas_consumption)]

# plot 
highchart() %>% 
    hc_add_series(ng_cons[, .(total_gas_consumption = sum(gas_consumption_bcm, na.rm = T)), by = .(region, year)], hcaes(x = year, y = total_gas_consumption, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Consumption: <b>{point.y}</b>")) %>%
    hc_title(text = "Total natural gas consumption by region") %>% 
    hc_subtitle(text = "Bcm") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Natural Gas: Consumption - Bcm (from 1965)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())

```

### __Growth in gas consumption__ {.no-padding}
```{r fig.height=3}
# Generate DT for gas contribution for 2018 (Billion cubic metres)
gas_contribution_18 <- ng_cons %>% 
  .[year %in% c(2017, 2018) & country != "USSR"] %>% 
  .[order(-gas_consumption_bcm)] %>% 
  .[, country_rank := ifelse(.I <=8, country, region)] %>% 
  .[, .(total_cons = sum(gas_consumption_bcm, na.rm = T)), by = c("country_rank", "year", "region")]


# extract the regions of top 4 contributeurs to convert them to Other regions for the other countries belonging to those regions (here : Other America, Other Asia & Other CIS)

region_rank <- gas_contribution_18[1:8,  .(region = unique(region))]

gas_contribution_18 <- gas_contribution_18[,  country := ifelse(country_rank %in% region_rank$region, paste0("other_", country_rank), country_rank)]

# Calculate top 3 contributors in 2018

# Adding the difference Y-on-Y for each country & for the total (lag) in order to calculate the percentage of contribution to the growth by country / region

Annual_gas_gr <- na.omit(gas_contribution_18[order(year)
                                     ][, lapply(.SD, function(x) 
                                       x-shift(x)), by = country, .SDcols=4
                                       ][, c("country", "diff_17_18", "gas_contribution_18", "total_cons") := .(country, total_cons, round(100*total_cons / sum(total_cons, na.rm = T), 2), NULL)
                                         ])[order(-gas_contribution_18)]

                               
top_3_gas_contr <- Annual_gas_gr[, head(.SD, 3), .SDcols=c("country", "gas_contribution_18")][, .(contrib = sum(gas_contribution_18))] %>% 
  pull()


# Create a line plot.
highchart() %>%
    hc_add_series(Annual_gas_gr, hcaes(x = country, y = gas_contribution_18, group = country), type = "column") %>%
    hc_tooltip(pointFormat = paste("<b>{point.y} %</b>")) %>%
    hc_title(text = "Contribution to gas consumption growth in 2018 (%)") %>%
    hc_subtitle(text = "") %>%
    hc_yAxis(title = list(text = "Contribution to gas consumption growth (%)"),
             labels = list(format = "{value}%")) %>%
    hc_add_theme(hc_theme_economist())

```

### __Global natural gas production__ {.no-padding}
```{r fig.height=3}
# Create for DT for Natural Gas Production (Billion cubic metres)
ng_production <- wide_to_long_1(25) %>% 
  .[, gas_production_bcm := round(as.numeric(gas_production_bcm), 2)]
# Add regions & clean unused rows (totals & remarks)  
ng_production <- get_regions(ng_production)

# create a plot
highchart() %>% 
    hc_add_series(ng_production[, .(total_gas_production = sum(gas_production_bcm, na.rm = T)), by = .(region, year)], hcaes(x = year, y = total_gas_production, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Production: <b>{point.y}</b>")) %>%
    hc_title(text = "Total natural gas production by region") %>% 
    hc_subtitle(text = "Bcm") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Natural Gas: production - Bcm (from 1965)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())
```

### __Growth in inter-regional natural gas trade__ {.no-padding}
```{r message=FALSE, warning=FALSE}
# Create DT for Growth in inter-regional natural gas trade (Billion cubic metres)
dt <- as.data.table(bp_stats$list.element[[32]])
# set few indexes to help me rename the columns and get rid of the unused columns
# first calculat the number of columns & take off 2
x <- ncol(dt) - 2
# get the second column name that will be used as the first date of our column serie of dates from 
# 2000 to the end of our column
y <- names(dt[,2])
x <- x + as.integer(y)
# set the names vector of our dt
col_names <- as.character(c("variable", y:x))
# change the names
names(dt) <- col_names
# get the position of the year 2018 to get rid of all the column above it
yr_2018 <- which(str_detect(col_names, "2018"))
dt <- dt[, 1:yr_2018]
# Now we need to get rid of the unused rows
# remove all row below the row that contains "Total trade" (rows containing comments)
dt <- dt[1:which(str_detect(variable, "Total trade"))]
# add country column to the dt. The 2 first operations set the country values
# in the new column and feel the rest with NA. The last operation roll on the country vector and feel all the NA with the correspondant country value
dt <- dt[, country := rowSums(.SD), .SDcols=2:ncol(dt)
         ][, country := ifelse(is.na(country), variable, NA_character_)
           ][, country := country[1], by = cumsum(!is.na(country)) # trick to roll up the values
             ]
dt <- na.omit(dt[, variable := str_replace(variable, "LNG exports(.)?", "LNG exports")])
dt <- melt(dt, id.vars = c("country", "variable"), measure.vars = 2:20, variable.name = "year", value.name = "inter_reg")
names(dt) <- c("country", "type", "year", "inter_reg")
dt <- dt[, ":=" (year = as.character(year),
         inter_reg = round(inter_reg, 2))]

highchart() %>% 
  hc_add_series(dt[type == "LNG exports" & !str_detect(type, "^Total"), .(total = sum(inter_reg, na.rm = T)), nomatch=0, by = .(year)], hcaes(x = as.numeric(year), y = total), type = "line") %>%
  hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","LNG Export: <b>{point.y}</b>")) %>%
  hc_title(text = "Growth of total LNG export since 2000") %>% 
  hc_subtitle(text = "Bcm") %>%
  hc_xAxis(title = list(text = "Year")) %>%
  hc_yAxis(title = list(text = "LNG export - Bcm (from 2000)"),
            plotBands = list(
             list(from = 400, to = 450,
                  label = list(text = "Growth in inter-regional natural gas trade was 39 bcm or 4.3%,", fontSize='15px')),
             list(from = 350, to = 400,
                  label = list(text = "more than double the 10-year average, driven largely by continuing")),
             list(from = 300, to = 350,
                  label = list(text = "rapid expansion in liquefied natural gas (LNG).")))) %>% 
  hc_legend(enabled = F) %>%  
  hc_add_theme(hc_theme_economist())
```

### __LNG trade movements 2018__ {.no-padding}
```{r fig.height=3}
 # Create DT for LNG trade movements 2018 (Billion cubic metres)
dt <- as.data.table(bp_stats$list.element[[35]])
name_col <- dt[1, 1:24] # get the first row that contains the variables names
names(dt) <- as.character(name_col[1, ]) # set the variables names
dt <- dt[2:40]
# melt the dt from wide to long
dt <- melt(dt, id.vars = "To", measure.vars = c(2:24), variable.name = "from")
dt <- dt[, value := round(as.numeric(value), 2)]
dt <- dt[!from %like% "^Total"][!To %like% "^Total"] # remove totals
setcolorder(dt, c("from", "To", "value"))
dt <- dt[value > 0]

# Load the world map dataset
world <- map_data("world")
world <- as.data.table(world)
world <- world[!region %like% "Antarctica"]
# Get the long & lat data of the capital cities tp serve as nodes
capitals <- maps::world.cities
capitals <- as.data.table(capitals)
capitals <- capitals[capital == 1]
names(capitals) <- c("name", "from", "pop", "lat", "long", "cap")
capitals <- capitals[, .(from, long, lat)]

# Harmonize the names of US, Russia & UK with the map names
dt <- dt[, c("from", "To") := .(ifelse(from %like% "US", "USA", ifelse(from %like% "Federation", "Russia", as.character(from))),
                          ifelse(To %like% "US", "USA", as.character(To)))
         ][, c("from", "To") := .(ifelse(from %like% "United Kingdom", "UK", as.character(from)), ifelse(To %like% "United Kingdom", "UK", as.character(To)))]

# add the long & lat data to the dt
dt <- dt %>% 
  inner_join(capitals, by = c(from = "from"))
names(dt) <- c("from",  "to",  "value", "start_long", "start_lat")
names(capitals) <- c("to", "long", "lat")
dt <- as.data.table(dt)

dt <- dt %>% 
  inner_join(capitals, by = c(to = "to"))


# Ploting the network map for the LNG trade movements 2018
base_gg <- ggplot() +
  geom_polygon(data = world,
               aes(long, lat, group = group), 
               show.legend = FALSE,
               alpha = 0.5,
               color = "gray") +
  geom_segment(data = dt, 
               aes(x = start_long, xend = long,
                   y = start_lat, yend = lat),
               color = "turquoise2",
               size = dt$value/5,
               alpha = 0.5) +
  geom_point(data = dt,
             aes(start_long, start_lat), color = "red", size = 3, alpha = .7) +
  geom_point(data = dt,
             aes(long, lat), color = "white", size = 3, alpha = .5) +
  labs(title = "LNG trade movements 2018 (Bcm)",
       subtitle = "Red cercles represent the exporting countries",
       caption = "T.Z") +
  dark_mode() +
  theme(axis.line = element_line(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.background = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.text = element_blank())
base_gg +
  coord_cartesian(xlim = c(dt["start_long", "min"],
                           dt["start_long", "max"]),
                  ylim = c(dt["start_lat", "min"],
                           dt["start_lat", "max"]))
```

### __Gas prices__ {.no-padding}
```{r fig.height=3}
# Create DT for Gas prices ($/Million Btu)
gas_prices <- as.data.table(bp_stats$list.element[[31]] %>% 
  setNames(c("year", "Japan_CIF", "Japan_Korea_Marker", "Average_German_Import", "UK_NBP", "Netherlands_TTF", "US_HH", "Canada_Alberta", "OCDE_CIF")) %>% 
    na.omit(., cols="year")) %>% 
  .[, lapply(.SD, as.numeric), by = year, .SDcols = 2:9] %>% 
  .[, lapply(.SD, round), by = year, .SDcols = 2:9] %>% 
  .[, year := year(anytime::anydate(year))]


gas_prices %>% 
  dygraph(main = "Gas prices ($/Million Btu)") %>% 
  dyRangeSelector() %>% 
  dyShading(from = "1990", to = "2002", color = "#FFE6E6") %>%
  dyShading(from = "2002", to = "2008", color = "#CCEBD6") %>%
  dyShading(from = "2009", to = "2013", color = "#FFE6E6") %>% 
  dyEvent("2008", "Economic recession", labelLoc = "bottom") %>% 
  dyLegend(show = "follow") 
```

Column {data-width=300}
-----------------------------------------------------------------------


```{r include=FALSE}
# these computing functions for the boxvalues
Gas_Production = function(...) return("190 bcm")
Gas_Cons = function(...) return("195 bcm")
Gas_Cons_Growth = function(...) return(ng_cons_diff_17_18[2]) 
```

### Global natural gas production increased by 190 bcm (5.2%).

```{r}
cont = Gas_Production()
valueBox(cont, icon = "fa-area-chart", color = "orange") 
```


### Natural gas consumption rose by 5.3%, one of the fastest rates of growth since 1984.

```{r}
articles = Gas_Cons()
valueBox(articles, icon = "fa-area-chart", color = "orange") 
```

### Growth in gas consumption was driven mainly by the US, China, Russia & Iran.

```{r}
 comments = Gas_Cons_Growth()
valueBox(comments, icon = "fa-area-chart", color = "orange")
```


Electricity & Renewables {data-icon="fa-signal"}
========================================================================

Column {.tabset .tabset-fade data-width=550 .custom }
-----------------------------------------------------------------------

### __Electricity generation__ {.no-padding}
```{r fig.height=3}
# Generate the dt for Electricity generation (Terawatt-hours)
electricity_generation <- as.data.table(wide_to_long_1(59))
electricity_generation <- electricity_generation[, c("electricity_generation", "electricity_generation_") := .(round(as.numeric(electricity_generation_), 2), NULL)]

# Get regions
electricity_generation <- get_regions(electricity_generation) 

# Create a line plot.
highchart() %>% 
    hc_add_series(electricity_generation[, .(total_electricity_generation = sum(electricity_generation, na.rm = T)), by = c("region", "year")], hcaes(x = year, y = total_electricity_generation, group = region, color = region), type = "line") %>%
    hc_tooltip(crosshairs = TRUE, borderWidth = 1.5, headerFormat = "", pointFormat = paste("Year: <b>{point.x}</b> <br>","region: <b>{point.region}</b><br>", "Generation: <b>{point.y}</b>")) %>%
    hc_title(text = "Total electricity generation by region") %>% 
    hc_subtitle(text = "Mtoe") %>%
    hc_xAxis(title = list(text = "Year")) %>%
    hc_yAxis(title = list(text = "Electricity generation - Terawatt-hours (from 1965)")) %>% 
    hc_legend(enabled = F) %>% 
    hc_add_theme(hc_theme_economist())
```

### __Contribution by fuel (Terawatt-hours)__ {.no-padding}
```{r fig.height=3}
# Get the dt for Electricity Contribution by fuel (Terawatt-hours)
contribution_source <- as.data.table(bp_stats$list.element[[60]])
names(contribution_source) <- names(contribution_source) <- c("country", "Oil_2017", "NaturalGas_2017", "Coal_2017", "Nuclear_2017", "Hydroelectric_2017", "Renewables_2017", "Others_2017",  "Total_2017", "Oil_2018", "NaturalGas_2018", "Coal_2018", "Nuclear_2018", "Hydroelectric_2018", "Renewables_2018", "Others_2018",  "Total_2018") 

# Get the index of the "Total World" row to remove the rows beyond it (rows containing comments)
index <- contribution_source[, which(country %like% "Total World")]
contribution_source <- na.omit(contribution_source[1:index])
contribution_source <- contribution_source[, lapply(.SD, round, 2), .SDcols = 2:17, by = country]

# Get regions
contribution_source <- get_regions(contribution_source) 

#Remove columns of totals
contribution_source <- contribution_source[, .SD, .SDcols = !patterns("^Total"), , by = .(country, region)]
# melt the dt
contribution_source <- melt(contribution_source, id.vars = c("country", "region"), measure.vars = c(3:16), variable.name = "type_year")  
# Split the type_year column in two columns
contribution_source <- contribution_source[, c("type", "year", "type_year") := .(str_extract(tolower(type_year), "[a-z]+"), str_extract(type_year, "\\d+"), NULL)]
# reorder the columns
contribution_source <- setcolorder(contribution_source, c("country", "region", "year", "type", "value"))

hchart(contribution_source[, .(total = sum(value, na.rm = T)), by = .(year, type)], "column", hcaes(x = type, y = total, group = year)) %>% 
  hc_title(text = "The share of renewable power in global power generation reached 9.32 % but coal still accounting for the largest share at 38%", style = list(color = "#111111")) 

```


### __Renewable Energy Generation by source__ {.no-padding}
```{r fig.height=3}
# Create DT for Renewables Energy Generation (Terawatt-hours)
renew_energy <- as.data.table(bp_stats$list.element[[50]])
# Clean the dt
number_col <- ncol(renew_energy) - 4
renew_energy <- renew_energy[, .SD, .SDcols=1:9] # remove the 4th last column that represente the growth 2018/2017
names(renew_energy) <- c("country","Wind_2017", "Solar_2017", "Other_renewables_2017",  "Total_2017",
                         "Wind_2018", "Solar_2018", "Other_renewables_2018",  "Total_2018") 
number_row <- renew_energy[, which(str_detect(country, "Total\\s?World"))] # get the number of the last useful row (Total World) to remove the rows with comments
renew_energy <- na.omit(renew_energy[1:number_row])
# Add a column of regions using the get_regions function we define in the script
renew_energy <- get_regions(renew_energy)
number_col <- ncol(renew_energy) # get the number of columns to apply rounding to the numerical columns(from 2 to last-1)
renew_energy <- renew_energy[, lapply(.SD, round, 2), .SDcols=2:(number_col - 1), by = .(country, region)]
#Remove columns of totals
renew_energy <- renew_energy[, .SD, .SDcols = !patterns("^Total"), , by = .(country, region)]
# melt the dt
renew_energy <- melt(renew_energy, id.vars = c("country", "region"), measure.vars = c(3:8), variable.name = "type_year")  
# Split the type_year column in two columns
renew_energy <- renew_energy[, c("type", "year", "type_year") := .(str_extract(tolower(type_year), "[a-z]+"), str_extract(type_year, "\\d+"), NULL)]
# reorder the columns
renew_energy <- setcolorder(renew_energy, c("country", "region", "year", "type", "value"))

hchart(renew_energy[, .(total = sum(value, na.rm = T)), by = .(year, type)], "column", hcaes(x = type, y = total, group = year)) %>% 
  hc_title(text = "Renewable Energy Generation by source (Terawatt-hours)", style = list(color = "#111111")) 
```

### __Contribution by country__ {.no-padding}
```{r fig.height=3}
# Generate the dt
dt <- as.data.table(bp_stats$list.element[[49]])
# Rename the first column
old_name <- names(dt[, 1])
colnames(dt)[colnames(dt) == old_name] <- 'country'

# Remove all the rows beyond the "Total World" row (comments)
number_row <- dt[, which(str_detect(country, "Total\\s?World"))]  
dt <- dt[1:number_row]

# Remove columns beyond 2018
number_col <- 2018 - as.integer(names(dt[, 2])) + 2
dt <- dt[, 1: number_col]
names(dt) <- c("country", "1965":"2018")

# Remove empty rows and rows of totals
dt <- dt[!is.na(country) & !country %like% "Total"]
dt <- melt(dt, id.vars = "country", measure.vars = c(2:number_col), variable.name = "year")

# Tidy the dt
dt <- dt[, .(country, 
             year = as.integer(as.character(year)),
             renewables_mtoe = round(as.numeric(value), 2))]

# Calculate the Annual growth 
Annual_gr <- dt[year %in% c(2017, 2018) & country != "USSR"
               ][order(year, -renewables_mtoe)
                 ][, lapply(.SD, function(x) 
                                       x-shift(x)), by = country, .SDcols=3
                   ][order(-renewables_mtoe)]

# Get the top 10 countries
top_10 <- Annual_gr[1:10, 1]

# Lump all the other countries to "Others"
Annual_gr <- Annual_gr[, country := ifelse(!country %in% top_10$country, "Others", country)]
Annual_gr <- Annual_gr[, lapply(.SD, sum, na.rm = TRUE), .SDcols = "renewables_mtoe", by = country
                       ][, lapply(.SD, round, 2), .SDcols = "renewables_mtoe", by = country]

highchart() %>%
    hc_add_series(Annual_gr, hcaes(x = country, y = renewables_mtoe, group = country), type = "column") %>%
    hc_tooltip(pointFormat = paste("<b>{point.y} </b>")) %>%
    hc_title(text = "Contribution to renewables growth in 2018 (mtoe)") %>%
    hc_subtitle(text = "") %>%
    hc_yAxis(title = list(text = "Contribution to renewables growth (mtoe)"),
             labels = list(format = "{value}")) %>%
    hc_add_theme(hc_theme_economist()) 
```

Column {data-width=300}
-----------------------------------------------------------------------


```{r include=FALSE}
# these computing functions for the boxvalues
Elect_Generation = function(...) return("3.7%")
Renew_Generation = function(...) return("14.5%")
Solar_Gen = function(...) return("40%")
China_Contr = function(...) return("32 mtoe") 
```

### Electricity generation rose by an above-average 3.7%

```{r}
cont = Elect_Generation()
valueBox(cont, icon = "fa-percent", color = "orange") 
```


### Renewable power grew by 14.5%.

```{r}
cont = Renew_Generation()
valueBox(cont, icon = "fa-percent", color = "orange") 
```


### Solar generation grew by 30 mtoe, providing more than 40% of renewables growth.

```{r}
articles = Solar_Gen()
valueBox(articles, icon = "fa-percent", color = "orange") 
```

### China the largest contributor to renewables growth (32 mtoe).

```{r}
 comments = China_Contr()
valueBox(comments, icon = "fa-area-chart", color = "orange")
```

